<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# storage

```go
import "github.com/aexvir/skladka/internal/storage"
```

Package storage provides the persistence layer for the skladka service. It implements a PostgreSQL\-based storage backend with support for:

- Storing and retrieving pastes with metadata
- Managing paste visibility \(public/private\)
- Handling paste expiration
- Reference generation and validation
- Content encryption for private pastes

The package uses sqlc for type\-safe SQL queries and includes metrics for monitoring database operations. It also integrates with the application's observability stack for logging and tracing.

Example usage:

```
db, err := storage.NewPostgresStorage(ctx, cfg)
if err != nil {
	return fmt.Errorf("failed to initialize storage: %w", err)
}

paste, err := db.GetPaste(ctx, reference)
if err != nil {
	return fmt.Errorf("failed to retrieve paste: %w", err)
}
```

## Index

- [type Cipher](<#Cipher>)
  - [func NewCipher\(key string\) \*Cipher](<#NewCipher>)
  - [func \(c \*Cipher\) Decrypt\(encrypted string\) \(string, error\)](<#Cipher.Decrypt>)
  - [func \(c \*Cipher\) Encrypt\(plaintext string\) \(string, error\)](<#Cipher.Encrypt>)
  - [func \(c \*Cipher\) Hash\(value string\) string](<#Cipher.Hash>)
- [type Metrics](<#Metrics>)
- [type PostgresStorage](<#PostgresStorage>)
  - [func NewPostgresStorage\(ctx context.Context, cfg config.Config, opts ...PostgresStorageOption\) \(\*PostgresStorage, error\)](<#NewPostgresStorage>)
  - [func \(s \*PostgresStorage\) CreatePaste\(ctx context.Context, paste paste.Paste\) \(string, error\)](<#PostgresStorage.CreatePaste>)
  - [func \(s \*PostgresStorage\) GetPaste\(ctx context.Context, ref string\) \(paste.Paste, error\)](<#PostgresStorage.GetPaste>)
  - [func \(s \*PostgresStorage\) ListPastes\(ctx context.Context\) \(\[\]paste.Paste, error\)](<#PostgresStorage.ListPastes>)
- [type PostgresStorageOption](<#PostgresStorageOption>)


<a name="Cipher"></a>
## type [Cipher](<https://github.com/aexvir/skladka/blob/master/internal/storage/cipher.go#L12-L14>)



```go
type Cipher struct {
    // contains filtered or unexported fields
}
```

<a name="NewCipher"></a>
### func [NewCipher](<https://github.com/aexvir/skladka/blob/master/internal/storage/cipher.go#L16>)

```go
func NewCipher(key string) *Cipher
```



<a name="Cipher.Decrypt"></a>
### func \(\*Cipher\) [Decrypt](<https://github.com/aexvir/skladka/blob/master/internal/storage/cipher.go#L46>)

```go
func (c *Cipher) Decrypt(encrypted string) (string, error)
```



<a name="Cipher.Encrypt"></a>
### func \(\*Cipher\) [Encrypt](<https://github.com/aexvir/skladka/blob/master/internal/storage/cipher.go#L26>)

```go
func (c *Cipher) Encrypt(plaintext string) (string, error)
```



<a name="Cipher.Hash"></a>
### func \(\*Cipher\) [Hash](<https://github.com/aexvir/skladka/blob/master/internal/storage/cipher.go#L20>)

```go
func (c *Cipher) Hash(value string) string
```



<a name="Metrics"></a>
## type [Metrics](<https://github.com/aexvir/skladka/blob/master/internal/storage/metrics.go#L8-L23>)

Metrics holds the metrics for the storage package.

```go
type Metrics struct {
    // PasteCreated counts the number of pastes created
    PasteCreated metric.Int64Counter `metric:"storage_paste_created_total,Number of pastes created"`

    // PasteSize tracks the size of created pastes in bytes
    PasteSize metric.Int64Histogram `metric:"storage_paste_size_bytes,Size of pastes in bytes"`

    // PasteRetrieved counts the number of paste retrievals
    PasteRetrieved metric.Int64Counter `metric:"storage_paste_retrieved_total,Number of pastes retrieved"`

    // PasteNotFound counts the number of paste retrieval attempts that resulted in not found
    PasteNotFound metric.Int64Counter `metric:"storage_paste_not_found_total,Number of paste retrieval attempts that resulted in not found"`

    // PasteErrors counts the number of errors encountered during paste operations
    PasteErrors metric.Int64Counter `metric:"storage_paste_errors_total,Number of errors encountered during paste operations"`
}
```

<a name="PostgresStorage"></a>
## type [PostgresStorage](<https://github.com/aexvir/skladka/blob/master/internal/storage/postgres.go#L20-L25>)



```go
type PostgresStorage struct {
    // contains filtered or unexported fields
}
```

<a name="NewPostgresStorage"></a>
### func [NewPostgresStorage](<https://github.com/aexvir/skladka/blob/master/internal/storage/postgres.go#L29>)

```go
func NewPostgresStorage(ctx context.Context, cfg config.Config, opts ...PostgresStorageOption) (*PostgresStorage, error)
```



<details><summary>Example</summary>
<p>



```go
package main

import (
	"context"

	"github.com/aexvir/skladka/internal/config"
	"github.com/aexvir/skladka/internal/errors"
	"github.com/aexvir/skladka/internal/storage"
)

func main() error {
	ctx := context.Background()

	db, err := storage.NewPostgresStorage(
		ctx,
		config.Config{
			Postgres: config.Postgres{},
		},
	)

	if err != nil {
		return errors.Wrap(err, "failed to initialize storage")
	}

	_, err = db.GetPaste(ctx, "abc123")
	return nil
}
```

</p>
</details>

<a name="PostgresStorage.CreatePaste"></a>
### func \(\*PostgresStorage\) [CreatePaste](<https://github.com/aexvir/skladka/blob/master/internal/storage/postgres.go#L72>)

```go
func (s *PostgresStorage) CreatePaste(ctx context.Context, paste paste.Paste) (string, error)
```



<a name="PostgresStorage.GetPaste"></a>
### func \(\*PostgresStorage\) [GetPaste](<https://github.com/aexvir/skladka/blob/master/internal/storage/postgres.go#L118>)

```go
func (s *PostgresStorage) GetPaste(ctx context.Context, ref string) (paste.Paste, error)
```



<a name="PostgresStorage.ListPastes"></a>
### func \(\*PostgresStorage\) [ListPastes](<https://github.com/aexvir/skladka/blob/master/internal/storage/postgres.go#L151>)

```go
func (s *PostgresStorage) ListPastes(ctx context.Context) ([]paste.Paste, error)
```



<a name="PostgresStorageOption"></a>
## type [PostgresStorageOption](<https://github.com/aexvir/skladka/blob/master/internal/storage/postgres.go#L27>)



```go
type PostgresStorageOption func(*PostgresStorage)
```

Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)
