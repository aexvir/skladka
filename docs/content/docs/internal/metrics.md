<!-- Code generated by gomarkdoc. DO NOT EDIT -->

# metrics

```go
import "github.com/aexvir/skladka/internal/metrics"
```

Package metrics provides a thin wrapper around [OpenTelemetry](<https://pkg.go.dev/go.opentelemetry.io/otel/sdk/metrics>)'s metrics sdk.

The meter instance is meant to be initialized as a singleton and injected into the context during the initialization of the application. Both OTLP exporter via gRPC and Prometheus exporters are supported and can be enabled simultaneously.

Every function that wants to record metrics should use the [metrics.FromContext](<#FromContext>) helper to obtain the meter instance in order to register its metrics. Metrics are defined using struct tags and must be registered before use.

### example usage

```
// initialize meter instance
meter, err := metrics.NewMeter(
	"service",
	"environment",
	"version",
	metrics.WithOtlpExporter("localhost", 4317),
)
if err != nil {
	log.Fatal(err)
}

// inject meter into context
ctx := metrics.NewContext(context.Background(), meter)
```

afterwards it can be used

```
// define metrics struct, usually at package level
type Metrics struct {
	CreatePaste   metric.Int64Counter    `metric:"storage_paste_create_total,Number of pastes created"`
	PasteSize     metric.Int64Histogram  `metric:"storage_paste_size_bytes,Size of pastes in bytes"`
}

// and reference them in the main package struct
type SqlStorage struct {
	metrics *Metrics
}

// register metrics, usually as part of the constructor function
met := newStorageMetrics
if err := meter.Register(met); err != nil {
	log.Fatal(err)
}

return &storage{
	metrics: met
}

// then in any function the metrics can be used via the reference
s.metrics.CreatePaste.Add(ctx, 1)
s.metrics.PasteSize.Record(ctx, pasteSize)
```

The metrics package automatically handles registration and management of OpenTelemetry metrics, making it easier to instrument code and collect metrics in production environments.

## Index

- [func Handler\(\) http.Handler](<#Handler>)
- [func NewContext\(parent context.Context, metrics \*Meter\) context.Context](<#NewContext>)
- [type Meter](<#Meter>)
  - [func FromContext\(ctx context.Context\) \*Meter](<#FromContext>)
  - [func NewMeter\(service, env, version string, opts ...MeterOption\) \(\*Meter, func\(context.Context\) error, error\)](<#NewMeter>)
  - [func NewNoopMeter\(\) \*Meter](<#NewNoopMeter>)
  - [func \(m \*Meter\) Register\(spec any\) error](<#Meter.Register>)
- [type MeterOption](<#MeterOption>)
  - [func WithOtlpExporter\(ctx context.Context, hostname string, port int\) MeterOption](<#WithOtlpExporter>)
  - [func WithPrometheusExporter\(\) MeterOption](<#WithPrometheusExporter>)


<a name="Handler"></a>
## func [Handler](<https://github.com/aexvir/skladka/blob/master/internal/metrics/handler.go#L13>)

```go
func Handler() http.Handler
```

Handler returns an http.Handler that exposes metrics in Prometheus format. This handler should be mounted on the /metrics endpoint of your HTTP server to enable scraping by Prometheus. The handler is only available when the WithPrometheusExporter option is used during meter initialization.

<a name="NewContext"></a>
## func [NewContext](<https://github.com/aexvir/skladka/blob/master/internal/metrics/context.go#L12>)

```go
func NewContext(parent context.Context, metrics *Meter) context.Context
```

NewContext returns a new context.Context that carries the provided meter instance. This context should be used as the parent context for all operations that need to record metrics. The meter can be retrieved using FromContext.

<a name="Meter"></a>
## type [Meter](<https://github.com/aexvir/skladka/blob/master/internal/metrics/meter.go#L21-L28>)

Meter is the central metrics registry that manages OpenTelemetry metrics. It provides a way to register and record metrics while abstracting away the underlying OpenTelemetry implementation details.

```go
type Meter struct {
    // contains filtered or unexported fields
}
```

<a name="FromContext"></a>
### func [FromContext](<https://github.com/aexvir/skladka/blob/master/internal/metrics/context.go#L22>)

```go
func FromContext(ctx context.Context) *Meter
```

FromContext returns the Meter stored in ctx if it exists, or a no\-op metrics instance. The no\-op instance will silently discard all metrics but still allow metric registration to work without any conditional logic in the code.

This function should be used to obtain the meter instance in any function that needs to record metrics. It will never return nil, making it safe to use without checks.

<a name="NewMeter"></a>
### func [NewMeter](<https://github.com/aexvir/skladka/blob/master/internal/metrics/meter.go#L39>)

```go
func NewMeter(service, env, version string, opts ...MeterOption) (*Meter, func(context.Context) error, error)
```

NewMeter creates a new metrics registry with the given service name, environment and version. Additional options can be provided to customize the metrics behavior, such as configuring exporters for OTLP or Prometheus. If no options are provided, a no\-op meter will be returned.

The service name, environment and version parameters are used to create a resource that identifies the service in the metrics backend.

Returns the meter instance, a shutdown function, and any error that occurred during initialization. The shutdown function should be called when the application is shutting down to ensure all metrics are flushed.

<a name="NewNoopMeter"></a>
### func [NewNoopMeter](<https://github.com/aexvir/skladka/blob/master/internal/metrics/meter.go#L80>)

```go
func NewNoopMeter() *Meter
```

NewNoopMeter creates a new no\-op metrics registry that silently discards all metrics. This is useful for testing or when metrics are not needed. All operations on the returned meter are no\-ops, but the API remains the same.

<a name="Meter.Register"></a>
### func \(\*Meter\) [Register](<https://github.com/aexvir/skladka/blob/master/internal/metrics/meter.go#L98>)

```go
func (m *Meter) Register(spec any) error
```

Register takes a struct with metric field tags and registers all metrics defined in it. The struct fields must be of OpenTelemetry metric types \(Counter, Gauge, Histogram\). The metric tag format is: \`metric:"name,description\[,unit\]"\`.

Example struct with metric tags:

```
type Metrics struct {
	Requests    metric.Int64Counter    `metric:"requests_total,Total number of requests"`
	Duration    metric.Float64Histogram`metric:"request_duration_seconds,Request duration,s"`
}
```

If called on a no\-op metrics instance, it will initialize all metrics as no\-op metrics.

<a name="MeterOption"></a>
## type [MeterOption](<https://github.com/aexvir/skladka/blob/master/internal/metrics/options.go#L18>)

MeterOption is a function that configures a Meter instance. Options are not safe for concurrent use during initialization. They should only be used when creating a new Meter instance.

```go
type MeterOption func(*Meter) error
```

<a name="WithOtlpExporter"></a>
### func [WithOtlpExporter](<https://github.com/aexvir/skladka/blob/master/internal/metrics/options.go#L26>)

```go
func WithOtlpExporter(ctx context.Context, hostname string, port int) MeterOption
```

WithOtlpExporter configures the metrics to be exported via OTLP to the specified endpoint. The exporter will connect to the specified hostname and port using gRPC without TLS. Metrics are exported every 5 seconds by default.

This option is not safe for concurrent use during initialization. It should only be used when creating a new Meter instance via NewMeter.

<a name="WithPrometheusExporter"></a>
### func [WithPrometheusExporter](<https://github.com/aexvir/skladka/blob/master/internal/metrics/options.go#L56>)

```go
func WithPrometheusExporter() MeterOption
```

WithPrometheusExporter configures the metrics to be exported in Prometheus format. This exporter is required to use the Handler function which exposes metrics via HTTP. The metrics will be available in Prometheus format at the /metrics endpoint.

This option is not safe for concurrent use during initialization. It should only be used when creating a new Meter instance via NewMeter.

Generated by [gomarkdoc](<https://github.com/princjef/gomarkdoc>)
